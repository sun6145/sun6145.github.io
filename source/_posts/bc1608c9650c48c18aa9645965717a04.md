---
layout: post
title: mkcertå¿«é€Ÿæ­å»ºHTTPS
abbrlink: bc1608c9650c48c18aa9645965717a04
tags:
  - nginx
  - mkcert
categories:
  - Linux
  - ç½‘ç»œ
date: 1746378088541
updated: 1746461962728
---

ä»‹ç» mkcert å·¥å…·ä¸€é”®ç”Ÿæˆæœ¬åœ°å¯ä¿¡ HTTPS è¯ä¹¦çš„å®Œæ•´æµç¨‹ï¼Œæ¶µç›–å®‰è£…é…ç½®ã€å¤šåŸŸåæ”¯æŒåŠæµè§ˆå™¨ä¿¡ä»»è®¾ç½®ã€‚æ— éœ€å¤æ‚ CA ç”³è¯·ï¼Œè½»æ¾å®ç° localhost å¼€å‘ç¯å¢ƒ HTTPS åŒ–ï¼Œæå‡å‰åç«¯è”è°ƒå®‰å…¨æ€§ä¸æ•ˆç‡ã€‚

<!-- more -->

***

## å‰è¨€

ä»¥å‰æœ¬åœ°å¼€å‘æ­å»º https ç¯å¢ƒæ—¶ï¼Œä½¿ç”¨çš„æ˜¯è‡ªç­¾è¯ä¹¦ï¼Œç”±äºæµè§ˆå™¨ä¸ä¿¡ä»»è‡ªç­¾è¯ä¹¦ï¼Œç»å¸¸éœ€è¦åœ¨è­¦å‘Šé¡µé¢ç‚¹å‡»ç»§ç»­è®¿é—®ï¼Œæœ‰äº›éº»çƒ¦ï¼š

![å›¾ 1](/resources/2cac20e223fe484e8d7ee01b8f37a480.png)

æœ‰æ—¶ç”šè‡³æ²¡æœ‰ç»§ç»­è®¿é—®çš„æŒ‰é’®ï¼Œå°±éœ€è¦åˆ° `chrome://net-internals/#hsts` é‡Œåˆ é™¤ç›¸å…³åŸŸåï¼Œæ›´éº»çƒ¦äº†ï¼Œè€Œä¸”è¿‡æ®µæ—¶é—´åè¿˜éœ€è¦é‡å¤æ“ä½œï¼š

![å›¾ 2](/resources/100b8cd18a3b40c98c562dfa9d1b7e08.png)

ä¸ºäº†ä¸è¿™ä¹ˆéº»çƒ¦ï¼Œéœ€è¦æˆ‘ä»¬å°†è‡ªç­¾è¯ä¹¦ä½¿ç”¨çš„æ ¹è¯ä¹¦æ·»åŠ åˆ°ç³»ç»Ÿçš„å¯ä¿¡ CA è¯ä¹¦ä¸­ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°è­¦å‘Šäº†ã€‚å½“ç„¶äº†è¾¾åˆ°è¿™ä¸ªæ•ˆæœéœ€è¦æ‰§è¡Œä¸€å † `openssl` å‘½ä»¤ï¼Œç¡®å®ç¹çï¼Œå¥½åœ¨å·²ç»æœ‰äº†å°è£…äº†è¿™äº›çš„å°å·¥å…· â€”â€” [mkcert](https://github.com/FiloSottile/mkcert) ã€‚

## mkcertä»‹ç»

> [mkcert](https://github.com/FiloSottile/mkcert) æ˜¯ä¸€ä¸ªä½¿ç”¨ go è¯­è¨€ç¼–å†™çš„ç”Ÿæˆæœ¬åœ°è‡ªç­¾è¯ä¹¦çš„å°ç¨‹åºï¼Œå…·æœ‰è·¨å¹³å°ã€ä½¿ç”¨ç®€å•ã€æ”¯æŒå¤šåŸŸåã€è‡ªåŠ¨ä¿¡ä»» CA ç­‰ä¸€ç³»åˆ—æ–¹ä¾¿çš„ç‰¹æ€§å¯ä¾›æœ¬åœ°å¼€å‘æ—¶å¿«é€Ÿåˆ›å»º https ç¯å¢ƒä½¿ç”¨ã€‚

![](/resources/18cbc049cfe84577af82f9546a136844.png)

### å®‰è£…

å®‰è£…æ–¹å¼ä¹Ÿéå¸¸ç®€å•ï¼Œç”±äº go è¯­è¨€çš„é™æ€ç¼–è¯‘å’Œè·¨å¹³å°çš„ç‰¹æ€§ï¼Œå®˜æ–¹æä¾›å„å¹³å°é¢„ç¼–è¯‘çš„ç‰ˆæœ¬ï¼Œç›´æ¥ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç»™å¯æ‰§è¡Œæƒé™(Linux/Unix éœ€è¦)å°±å¯ä»¥äº†ã€‚ä¸‹è½½åœ°å€: <https://github.com/FiloSottile/mkcert/releases/latest>

#### Windows

- ä½¿ç”¨ [Chocolatey](https://chocolatey.org/) æˆ– [Scoop](https://github.com/ScoopInstaller/scoop)

  ```sh
  choco install mkcert
  # æˆ–è€…
  scoop bucket add extras
  scoop install mkcert
  ```

- æˆ–è€…ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„æ–‡ä»¶

  è®¿é—® [GitHub Releases](https://github.com/FiloSottile/mkcert/releases) ä¸‹è½½ï¼ˆ[å¤‡ç”¨é“¾æ¥](https://download.fastgit.org/FiloSottile/mkcert/releases/download/v1.4.4/mkcert-v1.4.4-windows-amd64.exe)ï¼‰

  ç„¶åå¯ä»¥é‡å‘½åæ–‡ä»¶ä¸º `mkcert.exe` ï¼Œæ‰€åœ¨è·¯å¾„æ”¾åˆ°ç¯å¢ƒå˜é‡ Path é‡Œï¼Œæ–¹ä¾¿ç›´æ¥ä»¥ `mkcert` å‘½ä»¤è¿è¡Œ

  å¦‚æœè¿è¡Œæ—¶æœ‰é—®é¢˜çš„è¯ï¼Œåˆ‡æ¢ä¸ºä»¥ç®¡ç†å‘˜è¿è¡Œ

  ![image-20220923104612775](/resources/bfd22b8ea2ad41f0afb614a33bddec03.png)

#### macOS / Linux

ä½¿ç”¨ [Homebrew](https://brew.sh/) / [Homebrew on Linux](https://docs.brew.sh/Homebrew-on-Linux)

```mipsasm
brew install mkcert
brew install nss # å¦‚æœä½¿ç”¨ Firefox

yum install mkcert
```

## mkcert å‘½ä»¤

å®‰è£…æˆåŠŸåï¼Œåº”è¯¥å¯ä»¥ä½¿ç”¨`mkcert`å‘½ä»¤äº†,ä»ä¸Šé¢è‡ªå¸¦çš„å¸®åŠ©è¾“å‡ºæ¥çœ‹ï¼Œ`mkcert`å·²ç»ç»™å‡ºäº†ä¸€ä¸ªåŸºæœ¬çš„å·¥ä½œæµï¼Œè§„é¿äº†ç¹æ‚çš„`openssl`å‘½ä»¤ï¼Œå‡ ä¸ªç®€å•çš„å‚æ•°å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ªæœ¬åœ°å¯ä¿¡çš„ https è¯ä¹¦äº†ã€‚æ›´è¯¦ç»†çš„ç”¨æ³•ç›´æ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://github.com/FiloSottile/mkcert#mkcert)å°±å¥½ã€‚

```sh
PS C:\Users\abcfy\projects> mkcert
Using the local CA at "C:\Users\abcfy\AppData\Local\mkcert" âœ¨
Usage of mkcert:

        $ mkcert -install
        Install the local CA in the system trust store.

        $ mkcert example.org
        Generate "example.org.pem" and "example.org-key.pem".

        $ mkcert example.com myapp.dev localhost 127.0.0.1 ::1
        Generate "example.com+4.pem" and "example.com+4-key.pem".

        $ mkcert "*.example.it"
        Generate "_wildcard.example.it.pem" and "_wildcard.example.it-key.pem".

        $ mkcert -uninstall
        Uninstall the local CA (but do not delete it).

For more options, run "mkcert -help".
```

## mkcert å…¶ä»–é€‰é¡¹

- æ³¨æ„ï¼šéœ€è¦å°†è¿™äº›é€‰é¡¹æ”¾åœ¨åŸŸåä¹‹å‰

  ```sh
  -cert-file FILE, -key-file FILE, -p12-file FILE
    è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„/æ–‡ä»¶åã€‚

  -client
    ç”Ÿæˆç”¨äºå®¢æˆ·ç«¯èº«ä»½éªŒè¯çš„è¯ä¹¦ã€‚

  -ecdsa
    ä½¿ç”¨ ECDSA å¯†é’¥ç”Ÿæˆè¯ä¹¦ã€‚

  -pkcs12
    ç”Ÿæˆ PKCS12 æ ¼å¼çš„è¯ä¹¦ã€‚Java ç¨‹åºé€šå¸¸ä¸æ”¯æŒ PEM æ ¼å¼çš„è¯ä¹¦ï¼Œä½†æ˜¯æ”¯æŒ PKCS12 æ ¼å¼çš„è¯ä¹¦ã€‚

  -csr CSR
    æ ¹æ®æä¾›çš„ CSR ç”Ÿæˆè¯ä¹¦ã€‚ä¸é™¤ -install å’Œ -cert-file ä¹‹å¤–çš„æ‰€æœ‰å…¶ä»–é€‰é¡¹å†²çªã€‚
  ```

- ä¾‹å­ï¼š

  ```sh
  mkcert -key-file key.pem -cert-file cert.pem example.com *.example.com
  ```

## é…ç½®ç¤ºä¾‹

```mermaid
flowchart TD
    subgraph Windowsä¸»æœº
        A[å®‰è£… mkcert] --> B[ç”Ÿæˆæ ¹è¯ä¹¦: mkcert -install]
        B --> C[ç”ŸæˆåŸŸåè¯ä¹¦: mkcert *.fulsun.local]
        C --> D[ä¿®æ”¹ hosts æ–‡ä»¶: 192.168.61.10 fulsun.local]
        D --> E[å‘èµ· HTTPS è¯·æ±‚: fulsun.local:3306]
    end

    subgraph Nginxè™šæ‹Ÿæœº[192.168.61.10]
        F[å®‰è£… Nginx] --> G[é…ç½® SSL è¯ä¹¦]
        G --> H[è®¾ç½® TCP åå‘ä»£ç†: 3306 -> 192.168.61.11:3306]
    end


    E -->|HTTPS è¯·æ±‚| H
    H -->|è¿”å›åŠ å¯†å“åº”| E
```

### ä¿¡ä»» CA æ ¹è¯ä¹¦

> âš  Warning
>
> mkcert è‡ªåŠ¨ç”Ÿæˆçš„ `rootCA-key.pem` æ–‡ä»¶æä¾›äº†æ‹¦æˆªæ¥è‡ªæœ¬æœºå®‰å…¨è¯·æ±‚çš„å®Œæ•´èƒ½åŠ›ã€‚ä¸è¦åˆ†äº«è¿™ä¸ªæ–‡ä»¶ã€‚

- å°† mkcert ä½¿ç”¨çš„æ ¹è¯ä¹¦åŠ å…¥æœ¬åœ°å¯ä¿¡ CA ä¸­ï¼Œä»¥åç”±è¯¥ CA ç­¾å‘çš„è¯ä¹¦åœ¨**æœ¬åœ°**éƒ½æ˜¯å¯ä¿¡çš„

  ```sh
  mkcert.exe --install
  The local CA is now installed in the system trust store! âš¡ï¸
  The local CA is now installed in Java's trust store! â˜•ï¸
  ```

  ![](./edit-bc1608c9650c48c18aa9645965717a04/193721e51c694a4285ef8f39c7f00b5b.png)

- ç„¶åå¯ä»¥åœ¨ Windows çš„å¯ä¿¡ CA åˆ—è¡¨æ‰¾åˆ°è¯¥è¯ä¹¦

### ç”Ÿæˆè‡ªç­¾è¯ä¹¦

- ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆè¯ä¹¦æ–‡ä»¶å’Œç§é’¥æ–‡ä»¶ï¼Œç„¶åå°±å¯ä»¥ç”¨åœ¨ nginx ä¸Šäº†

  ```sh
  $ mkcert "*.fulsun.local" fulsun.local

  Created a new certificate valid for the following names ğŸ“œ
   - "*.fulsun.local"
   - "fulsun.local"

  Reminder: X.509 wildcards only go one level deep, so this won't match a.b.fulsun.local â„¹ï¸

  The certificate is at "./_wildcard.fulsun.local+1.pem" and the key at "./_wildcard.fulsun.local+1-key.pem" âœ…

  It will expire on 5 August 2027 ğŸ—“
  ```

- é…ç½®åŸŸåæ˜ å°„`C:\Windows\System32\drivers\etc\hosts`ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰ã€‚

  ```plaintext
  192.168.61.10 fulsun.local
  ```

### é…ç½® Nginx çš„ TCP åå‘ä»£ç†

1. åœ¨ 192.168.61.10 è™šæ‹Ÿæœºä¸‹å®‰è£… Nginxã€‚ å®˜ç½‘ [ä¸‹è½½ nginx](http://nginx.org/en/download.html) æˆ–ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œå…·ä½“æ­¥éª¤ä¸å†èµ˜è¿°

   ```sh
   # dnf install -y nginx
   sudo dnf install nginx-mod-stream
   ```

2. **ä¸Šä¼ è¯ä¹¦åˆ° Nginx è™šæ‹Ÿæœº**ï¼šå°† `./_wildcard.fulsun.local+1.pem` å’Œ `./_wildcard.fulsun.local+1-key.pem` å¤åˆ¶åˆ°è™šæ‹Ÿæœºï¼Œä¾‹å¦‚ `/etc/nginx/ssl`ã€‚

3. ä¿®æ”¹è™šæ‹Ÿæœºä¸‹çš„ nginx é…ç½®

   ```sh
   # vi /usr/local/nginx/conf/nginx.conf
   # ç›‘å¬ 80 ç«¯å£ï¼Œå¼ºåˆ¶è·³è½¬åˆ° HTTPS
   server {
       listen 80;
       listen [::]:80;
       server_name fulsun.local;

       # 301 æ°¸ä¹…é‡å®šå‘åˆ° HTTPS
       return 301 https://$host$request_uri;
   }

   server {
       listen 443 ssl;
       # ä¿®æ”¹ä¸ºæ‰€éœ€åŸŸåæˆ–è€… localhost
       server_name fulsun.local;
       index index.html index.htm index.php default.html default.htm default.php;
       root html;

       # mkcert ç”Ÿæˆçš„è¯ä¹¦è·¯å¾„ï¼ˆéœ€æ”¾åœ¨ Nginx å¯è®¿é—®çš„ä½ç½®ï¼‰
       ssl_certificate /etc/nginx/ssl/_wildcard.fulsun.local+1.pem;
       ssl_certificate_key /etc/nginx/ssl/_wildcard.fulsun.local+1-key.pem;

       ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m;
       ssl_ciphers HIGH:!aNULL:!MD5; ssl_prefer_server_ciphers on;

       # æ­¤å¤„ä¸ºä¸ªäººéœ€æ±‚ï¼Œä»£ç†è¯·æ±‚åˆ° 80 ç«¯å£
       location / {
           proxy_pass http://127.0.0.1;
           proxy_set_header Host $proxy_host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header Via "nginx";
       }
   }
   ```

### æ£€æŸ¥æ˜¯å¦ç”Ÿæ•ˆ

è¿è¡Œ nginx åè®¿é—®ï¼Œæ²¡æœ‰è­¦å‘Šé¡µé¢,è¯ä¹¦ä¹Ÿæ˜¯æœ‰æ•ˆçŠ¶æ€ï¼Œä¹‹åå¦‚æœè¯ä¹¦è¿‡æœŸçš„è¯å†é‡æ–°æ‰§è¡Œä¸€éå‘½ä»¤å³å¯

![](/resources/9d8d5e967def4188ab5b284955e53a26.png)

### è®¿é—®MysqlæœåŠ¡

- Nginx éœ€è¦å¯ç”¨ `ngx_stream_core_module` æ¨¡å—æ¥ä»£ç† TCP æµé‡ï¼ˆå¦‚ MySQL çš„ 3306 ç«¯å£ï¼‰ã€‚

- åœ¨è™šæ‹Ÿæœº192.168.61.11ä¸­å¯åŠ¨ä¸€ä¸ªmysqlæœåŠ¡

  ```sh
  docker pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/gcr.io/ml-pipeline/mysql:8.0.26
  docker rm -f mysql
  # å¯åŠ¨å®¹å™¨
  docker run \
  -p 3306:3306 \
  --restart=always \
  --name mysql \
  --privileged=true \
  -e MYSQL_ROOT_PASSWORD=123456 \
  -d swr.cn-north-4.myhuaweicloud.com/ddn-k8s/gcr.io/ml-pipeline/mysql:8.0.26
  ```

- Nginxä»£ç†æœåŠ¡

  ```sh
  # åœ¨Nginxä¸»é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸ä¸º/etc/nginx/nginx.confï¼‰çš„â€‹â€‹é¡¶å±‚â€‹â€‹ï¼ˆä¸åœ¨http{}å—å†…ï¼‰æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š
  stream {
      server {
          listen     3306;  # çº¯ TCP ç›‘å¬ï¼Œæ—  SSL
          proxy_pass 192.168.61.11:3306;

          # å¢åŠ  TCP ä»£ç†ä¼˜åŒ–å‚æ•°
          proxy_connect_timeout 60s;
          proxy_timeout       24h;  # é¿å…é•¿è¿æ¥è¶…æ—¶
          proxy_buffer_size   16k;  # è°ƒå¤§ç¼“å†²åŒºé˜²æ­¢åˆ†åŒ…
      }
  }
  ```

- è®¿é—®mysqlæœåŠ¡æˆåŠŸ
  ![](/resources/e0a25a567e7d4e01bacbc40bcf4a72b3.png)

## Reference

<https://www.nanoka.top/posts/d845bf65/>

<https://github.com/FiloSottile/mkcert>

<https://www.jianshu.com/p/7cb5c2cffaaa>
