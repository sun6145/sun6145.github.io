---
layout: post
title: Nginx安装指南
abbrlink: 43ac706e7d1041fab96ea68d47cd7495
tags:
  - nginx
categories:
  - Nginx
date: 1746081189378
updated: 1746380856825
---

详细讲解 Nginx 在 Linux/Windows 系统的安装步骤，包括源码编译和包管理器两种方式。涵盖基础配置检查、服务启动及防火墙设置，帮助开发者快速搭建高性能 Web 服务器环境。附常见问题解决方法，适合运维新手入门参考。

<!-- more -->

***

## 二进制包安装

Nginx 一般可以使用 apt/yum/dnf 来安装二进制包，若需使用特定的功能模块，则需要使用源码安装。

- OS：Rocky Linux 9.3 (Blue Onyx)

  ```sh
  # 检查当前系统可安装列表

  [root@RockyLinux9 ~]# dnf list nginx
  Available Packages
  nginx.x86_64                   1:1.20.1-14.el9_2.1                   appstream
  ```

- **配置官方 YUM 仓库**

  ```sh
  [root@RockyLinux9 ~]# cat /etc/yum.repos.d/nginx.repo
  [nginx-stable]
  name=nginx stable repo
  baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
  gpgcheck=1
  enabled=1
  gpgkey=https://nginx.org/keys/nginx_signing.key
  module_hotfixes=true

  [root@RockyLinux9 ~]# dnf list nginx
  Available Packages
  nginx.x86_64                    1:1.26.0-1.el9.ngx                nginx-stable
  ```

- **安装**

  ```sh
  [root@RockyLinux9 ~]# dnf install -y nginx
  # 服务启动并配置开机自启
  [root@RockyLinux9 ~]# systemctl enable nginx --now
  # 查看服务状态
  [root@RockyLinux9 ~]# systemctl status nginx
  ```

- **查看版本及默认编译依赖项**

  ```sh
  [root@RockyLinux9 ~]# nginx -V
  nginx version: nginx/1.26.0
  built by gcc 11.3.1 20221121 (Red Hat 11.3.1-4) (GCC)
  built with OpenSSL 3.0.7 1 Nov 2022
  TLS SNI support enabled
  configure arguments: --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_v3_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -flto=auto -ffat-lto-objects -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -fstack-protector-strong -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -march=x86-64-v2 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie'
  ```

- **二进制包安装的默认位置**

  ```sh
  [root@RockyLinux9 ~]# rpm -ql nginx
  /etc/nginx          # 配置文件目录
  ......
  /usr/lib64/nginx/modules        # 模块安装目录
  /usr/sbin/nginx      # 二进制程序
  /usr/share/nginx/html        # 网站根目录
  /var/cache/nginx        # 缓存目录
  /var/log/nginx        # 日志目录
  ```

## 源码编译安装

**1. 安装依赖**
首先安装编译 Nginx 所需的依赖：

```bash
sudo dnf install -y gcc make pcre-devel zlib-devel openssl-devel
```

***

**2. 下载 Nginx 源码**
[下载最新稳定版 Nginx](http://nginx.org/en/download.html)（以 `1.25.3` 为例）：

```bash
wget http://nginx.org/download/nginx-1.25.3.tar.gz
tar -zxvf nginx-1.25.3.tar.gz
cd nginx-1.25.3
```

***

**3. 编译安装 Nginx**
运行 `configure` 并启用 HTTPS 支持（`--with-http_ssl_module`）：

```bash
./configure \
    --prefix=/usr/local/nginx \
    --with-http_ssl_module \
    --with-http_v2_module \
    --with-http_stub_status_module
make && sudo make install
```

> 说明：
>
> - `--prefix=/usr/local/nginx`：指定安装目录
> - `--with-http_ssl_module`：启用 HTTPS 支持
> - `--with-http_v2_module`：支持 HTTP/2
> - `--with-http_stub_status_module`：启用 Nginx 状态监控
> - 1.21.5 及以上版本支持 PCRE2
> - `--with-pcre ` 指定 PCRE2 路径
> - `-with-pcre-jit` 启用 JIT 优化\`

***

**4. 配置 Nginx 服务**
​**​(1) 创建 systemd 服务 ​**​
创建 `/etc/systemd/system/nginx.service`：

bash

复制

```bash
sudo tee /etc/systemd/system/nginx.service <<EOF
[Unit]
Description=The nginx HTTP and reverse proxy server
After=network.target

[Service]
Type=forking
PIDFile=/usr/local/nginx/logs/nginx.pid
ExecStart=/usr/local/nginx/sbin/nginx
ExecReload=/usr/local/nginx/sbin/nginx -s reload
ExecStop=/usr/local/nginx/sbin/nginx -s stop
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF
```

**(2) 启动并设置开机自启**

bash

复制

```bash
sudo systemctl daemon-reload
sudo systemctl start nginx
sudo systemctl enable nginx
```

***

**5. 配置 HTTPS**
​**​(1) 生成 SSL 证书（自签名）​**​

bash

复制

```bash
sudo mkdir -p /usr/local/nginx/conf/ssl
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /usr/local/nginx/conf/ssl/nginx.key \
    -out /usr/local/nginx/conf/ssl/nginx.crt
```

> 说明：
>
> - 如果是生产环境，建议使用 Let's Encrypt 或 阿里云 SSL 证书。

**(2) 修改 Nginx 配置**
编辑 `/usr/local/nginx/conf/nginx.conf`，在 `server` 块中添加 HTTPS 配置：

nginx

复制

```nginx
server {
    listen 443 ssl;
    server_name your_domain.com;

    ssl_certificate /usr/local/nginx/conf/ssl/nginx.crt;
    ssl_certificate_key /usr/local/nginx/conf/ssl/nginx.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        root html;
        index index.html index.htm;
    }
}

server {
    listen 80;
    server_name your_domain.com;
    return 301 https://$host$request_uri;
}
```

**(3) 重启 Nginx**

bash

复制

```bash
sudo systemctl restart nginx
```

***

**6. 验证 HTTPS**
访问 `https://your_domain.com`，浏览器可能会提示证书不安全（自签名证书），但连接应该是加密的。

***

**7. 防火墙放行（可选）**
如果使用阿里云安全组或 `firewalld`，确保放行 80 和 443 端口：

bash

复制

```bash
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

***

**总结**
• 已编译安装 Nginx 并启用 HTTPS 支持。

• 配置了自签名 SSL 证书（生产环境建议使用 CA 签发的证书）。

• 设置了 HTTP 自动跳转 HTTPS。

• 使用 `systemd` 管理 Nginx 服务。

如果有问题，可以检查日志：

bash

复制

```bash
sudo tail -f /usr/local/nginx/logs/error.log
```

## Nginx 配置拆分

可以将 Nginx 的配置文件拆分为多个子文件，通过 `include` 指令组织管理。以下是具体步骤和示例：

### 1. 拆分思路

• 主配置文件 `nginx.conf`：保留核心配置（全局参数、事件模块、HTTP 模块入口）。

• 子配置文件：按功能或域名拆分成多个文件，存放在独立目录中。

• 通用配置：如 `gzip`、`ssl`、日志格式等。

• 虚拟主机配置：每个域名/应用单独一个文件。

• 模块化配置：如负载均衡、缓存规则等。

### 2. 目录结构建议

```bash
/usr/local/nginx/conf
├── nginx.conf               # 主配置文件
├── conf.d/                  # 通用配置片段
│   ├── gzip.conf
│   ├── ssl.conf
│   └── log_format.conf
├── sites-available/         # 所有虚拟主机配置（存放全部配置）
│   ├── example.com.conf
│   └── api.example.com.conf
├── sites-enabled/           # 启用的虚拟主机配置（软链接到 sites-available）
└── modules/                 # 模块化配置（可选）
    ├── proxy.conf
    └── cache.conf
```

***

### 3. 操作步骤

**步骤 1：备份原配置**

```bash
cp /usr/local/nginx/conf/nginx.conf /usr/local/nginx/conf/nginx.conf.bak
```

**步骤 2：修改主配置文件 `nginx.conf`**
保留核心配置，用 `include` 导入子文件：

```nginx
# 全局配置
user  nginx;
worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    # 基础配置
    include       /usr/local/nginx/conf/mime.types;
    default_type  application/octet-stream;

    # 导入通用配置
    include /usr/local/nginx/conf/conf.d/*.conf;

    # 导入虚拟主机配置
    include  /usr/local/nginx/conf/sites-enabled/*.conf;
}
```

**步骤 3：创建子配置文件**
• 通用配置示例（`conf.d/gzip.conf`）：

```nginx
gzip on;
gzip_types text/plain text/css application/json;
```

• 虚拟主机示例（`sites-available/fulsun.local.conf`）：

```nginx
server {
    listen 80;
    server_name fulsun.local;
    root /var/www/fulsun.local;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

步骤 4：启用虚拟主机

```bash
# 创建软链接（以启用 example.com.conf）
ln -s /usr/local/nginx/conf/sites-available/fulsun.local.conf /usr/local/nginx/conf/sites-enabled/
```

**步骤 5：检查并重载配置**

```bash
nginx -t         # 测试配置语法
nginx -s reload  # 重载配置
```

***

**4. 高级拆分（按模块）**
• 负载均衡配置（`modules/proxy.conf`）：

```nginx
upstream backend {
    server 10.0.0.1:8080;
    server 10.0.0.2:8080;
}
```

• 在虚拟主机中引用：

nginx

复制

```nginx
server {
    location / {
        proxy_pass http://backend;
        include /etc/nginx/modules/proxy.conf;  # 包含代理相关配置
    }
}
```

***

**5. 注意事项**
• 权限：确保 Nginx 进程有权限读取子配置文件（`chmod 644 *.conf`）。

• 路径：所有路径需使用绝对路径（如日志文件、SSL 证书）。

• 冲突：避免在不同子文件中重复定义相同指令（如 `server_name` 冲突）。

***

通过拆分，配置更易维护且结构清晰。Redis 相关配置（如缓存或会话共享）可以单独放在 `conf.d/redis.conf` 中，但需确保已正确集成 Redis 模块。
